<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>華信職福票 訂購單</title>
  <!-- 使用 xlsx-populate 保留格式 -->
  <script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>
  <style>
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    td, th { border: 1px solid #aaa; padding: 6px; text-align: left; }
    input, select { width: 120px; }
    button { margin: 5px; }

    /* iPhone 手機版：改成直向排列 */
    @media (max-width: 768px) {
      table, thead, tbody, tr, th, td {
        display: block;
        width: 100%;
      }

      thead { display: none; } /* 隱藏表頭 */

      tr { margin-bottom: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 8px; }

      td {
        border: none;
        padding: 8px 0;
      }

      td::before {
        content: attr(data-label);  /* 自動加上表頭名稱 */
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
        color: #333;
      }

      input, select {
        width: 100%;
        box-sizing: border-box;
        padding: 8px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <h2>華信職福票 多筆訂購單</h2>

  <table id="inputTable">
    <thead>
      <tr>
        <th>姓名</th>
        <th>身分證字號</th>
        <th>手機</th>
        <th>日期</th>
        <th>起站</th>
        <th>訖站</th>
        <th>班次</th>
        <th>時間</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td data-label="姓名"><input type="text" class="name" placeholder="請輸入姓名"></td>
        <td data-label="身分證字號"><input type="text" class="id" pattern="[A-Za-z][0-9]{9}" maxlength="10" placeholder="A123456789"></td>
        <td data-label="手機"><input type="tel" class="phone" pattern="[0-9]{10}" maxlength="10" placeholder="09xxxxxxxx"></td>
        <td data-label="日期"><input type="date" class="date"></td>
        <td data-label="起站">
          <select class="from">
            <option value="">選擇起站</option>
            <option value="台北">台北</option>
            <option value="桃園">桃園</option>
            <option value="新竹">新竹</option>
            <option value="台中">台中</option>
            <option value="台南">台南</option>
            <option value="左營">左營</option>
          </select>
        </td>
        <td data-label="訖站">
          <select class="to">
            <option value="">選擇訖站</option>
            <option value="台北">台北</option>
            <option value="桃園">桃園</option>
            <option value="新竹">新竹</option>
            <option value="台中">台中</option>
            <option value="台南">台南</option>
            <option value="左營">左營</option>
          </select>
        </td>
        <td data-label="班次"><input type="number" class="train" inputmode="numeric" placeholder="班次號碼"></td>
        <td data-label="時間"><input type="time" class="time"></td>
        <td data-label="操作"><button type="button" onclick="deleteRow(this)">刪除</button></td>
      </tr>
    </tbody>
  </table>

  <button type="button" onclick="addRow()">新增一筆</button>
  <button type="button" onclick="generateExcel()">下載 Excel</button>

  <script>
    // 新增一列
    function addRow() {
      const table = document.getElementById("inputTable").getElementsByTagName("tbody")[0];
      const newRow = table.rows[0].cloneNode(true);
      newRow.querySelectorAll("input, select").forEach(el => el.value = "");
      table.appendChild(newRow);
    }

    // 刪除列
    function deleteRow(btn) {
      const row = btn.parentNode.parentNode;
      const tbody = document.getElementById("inputTable").getElementsByTagName("tbody")[0];
      if (tbody.rows.length > 1) row.remove();
    }

    async function generateExcel() {
      // 1. 載入 Excel 範本
      const response = await fetch("TicketForm.xlsx");
      const arrayBuffer = await response.arrayBuffer();
      const workbook = await XlsxPopulate.fromDataAsync(arrayBuffer);

      // 2. 選擇工作表
      const sheet = workbook.sheet("空白訂購單");

      // 3. 只寫入「這裡」欄位 (從第 4 列開始)
      const tbody = document.getElementById("inputTable").getElementsByTagName("tbody")[0];
      for (let i = 0; i < tbody.rows.length; i++) {
        const row = tbody.rows[i];
        const r = 4 + i; // 第 4 列開始

        sheet.cell(`A${r}`).value(row.querySelector(".name").value);   // 姓名
        sheet.cell(`C${r}`).value(row.querySelector(".id").value);     // 身分證字號
        sheet.cell(`D${r}`).value(row.querySelector(".phone").value);  // 手機
        sheet.cell(`E${r}`).value(row.querySelector(".date").value);   // 日期
        sheet.cell(`F${r}`).value(row.querySelector(".from").value);   // 起站
        sheet.cell(`G${r}`).value(row.querySelector(".to").value);     // 訖站
        sheet.cell(`H${r}`).value(row.querySelector(".train").value);  // 班次
        sheet.cell(`I${r}`).value(row.querySelector(".time").value);   // 時間
        // ⚠️ 不改 B、J、K，保持範本原本的「全票 / APP取票 / 收據需求」
      }

      // 4. 匯出 Excel
      const blob = await workbook.outputAsync();
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "華信職福票.xlsx";
      link.click();
    }
  </script>
</body>
</html>

