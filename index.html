<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>華信職福票 訂購單</title>
  <!-- 使用 xlsx-style 保留 Excel 格式 -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    table { border-collapse: collapse; margin-top: 20px; }
    td, th { border: 1px solid #aaa; padding: 6px; }
    input, select { width: 120px; }
    button { margin: 5px; }
  </style>
</head>
<body>
  <h2>華信職福票 多筆訂購單</h2>

  <table id="inputTable">
    <thead>
      <tr>
        <th>姓名</th>
        <th>身分證字號</th>
        <th>手機</th>
        <th>日期</th>
        <th>起站</th>
        <th>訖站</th>
        <th>班次</th>
        <th>時間</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" class="name"></td>
        <td><input type="text" class="id"></td>
        <td><input type="text" class="phone"></td>
        <td><input type="date" class="date"></td>
        <td>
          <select class="from">
            <option value="">--</option>
            <option value="台北">台北</option>
            <option value="板橋">板橋</option>
            <option value="左營">左營</option>
          </select>
        </td>
        <td>
          <select class="to">
            <option value="">--</option>
            <option value="桃園">桃園</option>
            <option value="台中">台中</option>
            <option value="台南">台南</option>
          </select>
        </td>
        <td><input type="text" class="train"></td>
        <td><input type="time" class="time"></td>
        <td><button type="button" onclick="deleteRow(this)">刪除</button></td>
      </tr>
    </tbody>
  </table>

  <button type="button" onclick="addRow()">新增一筆</button>
  <button type="button" onclick="generateExcel()">下載 Excel</button>

  <script>
    // 新增一列輸入
    function addRow() {
      const table = document.getElementById("inputTable").getElementsByTagName("tbody")[0];
      const newRow = table.rows[0].cloneNode(true);
      newRow.querySelectorAll("input, select").forEach(el => el.value = "");
      table.appendChild(newRow);
    }

    // 刪除列
    function deleteRow(btn) {
      const row = btn.parentNode.parentNode;
      const tbody = document.getElementById("inputTable").getElementsByTagName("tbody")[0];
      if (tbody.rows.length > 1) row.remove();
    }

    // 字串轉 ArrayBuffer（xlsx-style 需要）
    function s2ab(s) {
      const buf = new ArrayBuffer(s.length);
      const view = new Uint8Array(buf);
      for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
      return buf;
    }

    async function generateExcel() {
      // 載入範本
      const response = await fetch("TicketForm.xlsx");
      const arrayBuffer = await response.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: "array", cellStyles: true });
      const ws = workbook.Sheets["空白訂購單"];

      // 從第 3 列開始填寫
      const tbody = document.getElementById("inputTable").getElementsByTagName("tbody")[0];
      for (let i = 0; i < tbody.rows.length; i++) {
        const row = tbody.rows[i];
        const r = 3 + i; // Excel 第3列開始
        ws[`A${r}`].v = row.querySelector(".name").value;   // 姓名
        ws[`C${r}`].v = row.querySelector(".id").value;     // 身分證字號
        ws[`D${r}`].v = row.querySelector(".phone").value;  // 手機
        ws[`E${r}`].v = row.querySelector(".date").value;   // 日期
        ws[`F${r}`].v = row.querySelector(".from").value;   // 起站
        ws[`G${r}`].v = row.querySelector(".to").value;     // 訖站
        ws[`H${r}`].v = row.querySelector(".train").value;  // 班次
        ws[`I${r}`].v = row.querySelector(".time").value;   // 時間
      }

      // 匯出 Excel（用 binary）
      const newWB = XLSX.write(workbook, { bookType: "xlsx", type: "binary", cellStyles: true });
      const blob = new Blob([s2ab(newWB)], { type: "application/octet-stream" });

      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "華信職福票.xlsx";
      link.click();
    }
  </script>
</body>
</html>
